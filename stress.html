<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ストレス解消パンチシミュレーター</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#ff7a7a;--muted:#9aa4b2}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background:linear-gradient(180deg,#071022 0%,var(--bg) 100%);color:#e6eef6}
    .wrap{max-width:920px;margin:28px auto;padding:18px}
    header{display:flex;gap:12px;align-items:center}
    h1{font-size:18px;margin:0}
    p.lead{margin:6px 0 12px;color:var(--muted);font-size:13px}

    .game{display:grid;grid-template-columns:1fr 320px;gap:18px}
    @media(max-width:880px){.game{grid-template-columns:1fr;}}

    .stage{background:linear-gradient(180deg,#082033,#071022);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    canvas{width:100%;height:480px;border-radius:8px;background:linear-gradient(180deg,#0b2440,#072039)}

    .panel{background:linear-gradient(180deg,#07121b,#0b1722);border-radius:12px;padding:14px;color:var(--muted);box-shadow:0 6px 14px rgba(0,0,0,0.5)}
    .panel h2{color:#e6eef6;margin:0 0 10px;font-size:15px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:#e6eef6;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);color:#10202a;border:0}

    .meter{height:12px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden}
    .meter > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#ffb3b3);width:40%}
    .muted{color:var(--muted);font-size:13px}

    footer.small{margin-top:12px;color:var(--muted);font-size:12px}

    /* target SVG styling */
    .avatar{width:84px;height:84px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:#f6f9fb22;backdrop-filter: blur(2px)}

    /* subtle particle */
    .particle{position:absolute;border-radius:50%;opacity:0.9}

    .controls{display:flex;flex-direction:column;gap:8px}
    select,input[type=range]{width:100%}

    .disclaimer{margin-top:10px;color:#ffd5d5;background:#3b0b0b1a;padding:10px;border-radius:8px;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#11263a,#16324a);display:flex;align-items:center;justify-content:center;font-weight:700">Punch</div>
      <div>
        <h1>ストレス解消パンチシミュレーター</h1>
        <p class="lead">タップ／クリックで対象をパンチしてストレスを減らすカジュアルなデモ。実在の人物を攻撃することを助長しないため、対象は抽象化できます。</p>
      </div>
    </header>

    <main class="game" role="main">
      <section class="stage">
        <canvas id="gameCanvas" width="800" height="480" aria-label="ゲーム画面"></canvas>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div class="muted">コンボ: <strong id="combo">0</strong></div>
          <div style="width:60%">
            <div class="muted">ストレスメーター</div>
            <div class="meter" aria-hidden="true"><i id="stressBar" style="width:60%"></i></div>
          </div>
          <div class="muted">スコア: <strong id="score">0</strong></div>
        </div>
      </section>

      <aside class="panel">
        <h2>設定</h2>
        <div class="controls">
          <label class="muted">ターゲット</label>
          <select id="targetSelect">
            <option value="bag">パンチバッグ（無害）</option>
            <option value="cloud">怒り雲（抽象化）</option>
            <option value="monster">ドットモンスター（カートゥーン）</option>
          </select>

          <label class="muted">強さ（1〜5）</label>
          <input id="powerRange" type="range" min="1" max="5" value="3">

          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn" id="resetBtn">リセット</button>
            <button class="btn primary" id="calmBtn">落ち着くヒント</button>
          </div>

          <div class="disclaimer">
            注: 実在の人物への攻撃を助長する目的で使わないでください。もし強い怒りや衝動があるなら、信頼できる人や専門家に相談してください。
          </div>
        </div>

        <h2 style="margin-top:12px">遊び方</h2>
        <p class="muted">画面をタップ／クリックするとパンチ。コンボが続くとスコアUP。スマホでも快適に動きます。</p>

        <footer class="small">ファイルとして保存してブラウザで開いてください（オフラインで動作）。</footer>
      </aside>
    </main>
  </div>

  <script>
  // シンプルな一画面ゲームエンジン
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  let W = canvas.width, H = canvas.height;

  const scoreE = document.getElementById('score');
  const comboE = document.getElementById('combo');
  const barE = document.getElementById('stressBar');

  let state = {
    score:0,
    combo:0,
    stress:60, // 0 = calm, 100 = max
    power:3,
    target:'bag',
    lastPunch:0
  }

  function resize() {
    // canvas CSS size handled via responsive; internal pixel size stays constant for simplicity
  }

  window.addEventListener('resize', resize);

  // input handling (mouse + touch)
  function pointerPos(e){
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
    const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;
    return {x,y};
  }

  canvas.addEventListener('mousedown', onPunch);
  canvas.addEventListener('touchstart', function(e){e.preventDefault(); onPunch(e);});

  function onPunch(e){
    const p = pointerPos(e);
    doPunch(p.x,p.y);
  }

  // particles
  const particles = [];
  function spawnParticles(x,y,power){
    for(let i=0;i<10+power*4;i++){
      particles.push({x,y,dx:(Math.random()-0.5)*6,dy:(Math.random()-1.5)*6,life:40+Math.random()*20,r:2+Math.random()*3});
    }
  }

  function doPunch(x,y){
    const now = Date.now();
    const dt = now - state.lastPunch;
    if(dt < 120) return; // フレーム制限
    state.lastPunch = now;

    // スコア計算
    const base = 10 * state.power;
    // コンボ判定
    if(dt < 900){ state.combo += 1; } else { state.combo = 1; }
    const comboBonus = Math.floor(state.combo/5)*20;
    state.score += base + comboBonus;
    state.stress = Math.max(0, state.stress - (2*state.power + Math.min(40,state.combo)) );

    // spawn visual particles around click
    spawnParticles(x,y,state.power);

    // screen shake
    shake(6 + state.power*2);

    updateUI();
    playHitSound(state.power);
  }

  function updateUI(){
    scoreE.textContent = state.score;
    comboE.textContent = state.combo;
    barE.style.width = Math.max(0, Math.min(100, state.stress)) + '%';
  }

  // vibration if supported
  function vibrate(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

  // rudimentary sound using WebAudio
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const aCtx = AudioCtx?new AudioCtx():null;
  function playHitSound(power){
    if(!aCtx) return;
    const o = aCtx.createOscillator();
    const g = aCtx.createGain();
    o.type = 'sawtooth';
    o.frequency.value = 220 + power*80 - Math.random()*30;
    g.gain.value = 0.08;
    o.connect(g);g.connect(aCtx.destination);
    o.start();
    setTimeout(()=>{g.gain.exponentialRampToValueAtTime(0.0001,aCtx.currentTime+0.12);o.stop(aCtx.currentTime+0.15)},120);
  }

  // shake
  let shakeAmt=0;
  function shake(v){ shakeAmt = Math.min(18, shakeAmt + v); vibrate(20); }

  // target render
  function drawTarget(x,y,sz){
    ctx.save();
    ctx.translate(x,y);
    // draw based on state.target
    if(state.target === 'bag'){
      // simple punching bag
      ctx.fillStyle = '#ff9b9b';
      ctx.beginPath(); ctx.ellipse(0,0,sz*0.6,sz*0.9,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = '#b33'; ctx.fillRect(-sz*0.25,-sz*1.02,sz*0.5,sz*0.12);
      ctx.fillStyle = '#fff4'; ctx.fillRect(-sz*0.3,-sz*0.1,sz*0.6,sz*0.2);
    } else if(state.target === 'cloud'){
      // anger cloud
      ctx.fillStyle = '#ffffff14';
      for(let i=0;i<5;i++){
        ctx.beginPath(); ctx.arc(-sz*0.3 + i*sz*0.15, -sz*0.05, sz*0.35, 0, Math.PI*2); ctx.fill();
      }
      ctx.fillStyle = '#ffcbc8'; ctx.font = Math.round(sz*0.5)+'px serif'; ctx.textAlign='center'; ctx.fillText('怒', 0, 0+sz*0.12);
    } else {
      // monster
      ctx.fillStyle='#ffc09b'; ctx.beginPath(); ctx.ellipse(0,0,sz*0.7,sz*0.75,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(-sz*0.2,-sz*0.1,sz*0.12,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(sz*0.2,-sz*0.1,sz*0.12,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#c33'; ctx.fillRect(-sz*0.25,sz*0.18,sz*0.5,sz*0.12);
    }
    ctx.restore();
  }

  // game loop
  let t=0;
  function loop(){
    t += 1;
    // update
    if(shakeAmt>0) shakeAmt *= 0.86; else shakeAmt = 0;
    // draw
    ctx.clearRect(0,0,W,H);
    // camera shake translate
    const sx = (Math.random()-0.5)*shakeAmt;
    const sy = (Math.random()-0.5)*shakeAmt;
    ctx.save(); ctx.translate(sx,sy);

    // background grid
    ctx.fillStyle='rgba(255,255,255,0.02)';
    for(let i=0;i<12;i++){ ctx.fillRect(0, H*0.18 + i*28, W, 1); }

    // draw target center
    const cx = W*0.5, cy = H*0.42;
    drawTarget(cx, cy, Math.min(160, Math.min(W,H)*0.22));

    // particles
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.dx; p.y += p.dy; p.dy += 0.2; p.life -= 1;
      ctx.fillStyle = 'rgba(255,210,210,'+Math.max(0, p.life/60)+')';
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      if(p.life <= 0) particles.splice(i,1);
    }

    ctx.restore();

    // auto calm: if stress low, slowly refill (you feel calmer)
    if(state.stress <= 10 && state.combo>0){ state.combo = Math.max(0, state.combo-1); }

    requestAnimationFrame(loop);
  }

  // UI bindings
  document.getElementById('targetSelect').addEventListener('change', (e)=>{ state.target=e.target.value; });
  document.getElementById('powerRange').addEventListener('input', (e)=>{ state.power = Number(e.target.value); });
  document.getElementById('resetBtn').addEventListener('click', ()=>{ state.score=0; state.combo=0; state.stress=60; updateUI(); });
  document.getElementById('calmBtn').addEventListener('click', ()=>{ showCalmTips(); });

  function showCalmTips(){
    alert('深呼吸を3回してみましょう。信頼できる人に話す、短い散歩をする、音楽を聴くなども有効です。深刻な衝動がある場合は医療機関に相談してください。');
  }

  // initial
  updateUI();
  loop();

  // accessibility: keyboard input
  window.addEventListener('keydown', (e)=>{ if(e.key === ' ') doPunch(W/2,H/2); });
  </script>
</body>
</html>
